{{ 'roller-config.css' | asset_url | stylesheet_tag }}
{{ 'auth-config.js' | asset_url | script_tag }}

<div id="auth-guard"></div>
<div class="roller-customizer" id="customizer-content" style="display: none;">
  <h2>Rollladen nach Ma√ü konfigurieren</h2>

  <form id="roller-config-form" method="POST">
    <!-- Project/Commission Field -->
    <div class="form-group">
      <label for="project-ref">Projekt/Kommission (optional)</label>
      <input type="text" id="project-ref" name="properties[Project]" maxlength="30" placeholder="z.B. K√ºche Fenster 1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
    </div>

    <!-- Material Selection -->
    <div class="form-group">
      <label>
        Material
        <div class="tooltip-wrapper">
          <div class="tooltip-trigger">?</div>
          <div class="tooltip-content">
            <h4>Materialvergleich</h4>
            <p><strong>Aluminium:</strong><br>Stranggepresst, PU-gesch√§umt, h√∂here Stabilit√§t, bessere Isolierung, langlebiger.</p>
            <p><strong>PVC:</strong><br>Hochwertiger Kunststoff, pflegeleicht, kosteng√ºnstiger, gute W√§rmed√§mmung.</p>
            <!-- Placeholder for image -->
            <div style="margin-top:10px; height: 100px; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.8rem;">
              Bild: Alu vs PVC
            </div>
          </div>
        </div>
      </label>
      <div class="radio-group">
        <label>
          <input type="radio" name="material" value="alu" checked>
          Aluminium
        </label>
        <label>
          <input type="radio" name="material" value="pvc">
          PVC
        </label>
      </div>
    </div>

    <!-- Profile Selection -->
    <div class="form-group">
      <label>
        Profilh√∂he
        <div class="tooltip-wrapper">
          <div class="tooltip-trigger">?</div>
          <div class="tooltip-content">
            <h4>Profilgr√∂√üen</h4>
            <p><strong>Mini (37mm):</strong><br>Ideal f√ºr begrenzten Platz im Rolladenkasten. Deckbreite 37mm.</p>
            <p><strong>Maxi (52mm):</strong><br>F√ºr gr√∂√üere Fenster und mehr Stabilit√§t. Deckbreite 52mm.</p>
            <!-- Placeholder for image -->
            <div style="margin-top:10px; height: 100px; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.8rem;">
              Bild: Mini vs Maxi
            </div>
          </div>
        </div>
      </label>
      <div class="radio-group">
        <label>
          <input type="radio" name="profile" value="mini" checked>
          Mini (37 mm)
        </label>
        <label>
          <input type="radio" name="profile" value="maxi">
          Maxi (52 mm)
        </label>
      </div>
    </div>

    <!-- Material & Profile Details (Collapsible) -->
    <div class="details-section" style="margin-bottom: 2rem; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;">
      <button type="button" class="instructions-toggle" data-target="details-container" style="width: 100%; text-align: left; padding: 1rem; background: #f9f9f9; border: none; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span>‚ÑπÔ∏è Material & Profil Details</span>
        <span class="toggle-icon">‚ñº</span>
      </button>
      
      <div class="instructions-container" id="details-container" style="display: none; padding: 1rem; background: #fff; border-top: 1px solid #e0e0e0;">
        <div class="instruction-content">
          <h4 style="margin-top: 0;">Material Eigenschaften</h4>
          <p style="margin-bottom: 0.5rem;"><strong>Aluminium:</strong> Stranggepresst und mit PU gesch√§umt f√ºr h√∂chste Stabilit√§t und Isolierung.</p>
          <p><strong>PVC:</strong> Hochwertiger Kunststoff, pflegeleicht und witterungsbest√§ndig.</p>
          
          <h4 style="margin-top: 1rem;">Profil Details</h4>
          <ul style="padding-left: 1.2rem; margin-bottom: 0;">
            <li style="margin-bottom: 0.5rem;">
              <strong>PVC Mini:</strong> Deckbreite 37 mm, Nenndicke 8 mm, Max. Breite 1600 mm, Max. Fl√§che 3 m¬≤
            </li>
            <li style="margin-bottom: 0.5rem;">
              <strong>PVC Maxi:</strong> Deckbreite 52 mm, Nenndicke 14 mm, Max. Breite 2400 mm, Max. Fl√§che 4,3 m¬≤
            </li>
            <li style="margin-bottom: 0.5rem;">
              <strong>Alu Mini:</strong> Deckbreite 37 mm, Nenndicke 8,3 mm, Max. Breite 3000 mm, Max. Fl√§che 7 m¬≤
            </li>
             <li>
              <strong>Alu Maxi:</strong> Deckbreite 52 mm, Nenndicke 13,8 mm, Max. Breite 4000 mm, Max. Fl√§che 8 m¬≤
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Main Content Flex Container -->
    <div class="form-content-wrapper">
      <!-- Image Preview (Left on Desktop, Top on Mobile) -->
      <div class="image-section">
        <div class="image-preview-container">
          <img id="roller-image" src="" alt="Rollladen Vorschau" class="roller-preview-image">
        </div>
      </div>

      <!-- Form Content (Right on Desktop, Below Image on Mobile) -->
      <div class="form-section">
        <!-- Dimensions -->
        <div class="form-group">
          <label>Abmessungen (mm)</label>
          <div class="dimension-group">
            <div class="dimension-input">
              <label for="width">Breite (mm)</label>
              <input type="number" id="width" name="width" min="0" step="1" required>
              <div id="width-constraints" style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;"></div>
              <div id="width-error" style="font-size: 0.8rem; color: #d00; margin-top: 0.25rem; font-weight: bold;"></div>
            </div>
            <div class="dimension-input">
              <label for="height">H√∂he (mm)</label>
              <input type="number" id="height" name="height" min="0" step="1" required>
              <div id="height-constraints" style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;"></div>
              <div id="height-error" style="font-size: 0.8rem; color: #d00; margin-top: 0.25rem; font-weight: bold;"></div>
            </div>
          </div>

          <!-- Area Display -->
          <div class="price-display">
            <div class="label">Fl√§che</div>
            <span id="area-display">0.000</span> m¬≤
            <div id="minimum-warning" style="display: none; color: #d97706; font-size: 0.85rem; margin-top: 0.25rem;">Hinweis: Mindestberechnung 1,00 m¬≤</div>
            <div id="area-constraints" style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;"></div>
            <div id="area-error" style="font-size: 0.85rem; color: #d00; margin-top: 0.25rem; font-weight: bold;"></div>
          </div>
          
          <!-- Measurement Instructions Link (Relocated) -->
          <div class="instructions-link-wrapper" style="margin-top: 1.5rem;">
            <a href="#" class="instructions-toggle" data-target="instructions-container" style="color: var(--primary-color); text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem;">
              <span>üìè Anleitung zum Ausmessen</span>
              <span class="toggle-icon">‚ñº</span>
            </a>
            
            <div class="instructions-container" id="instructions-container" style="display: none; margin-top: 1rem; border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; background: white;">
              <h3>Informationen und Bestellangaben</h3>
              
              <div class="instruction-content">
                <h4>Informationen zur Ma√üermittlung</h4>
                <p>Im Folgenden steht alles Notwendige um Ihren ma√ügefertigten Rollladenpanzer richtig auszumessen und richtig zu bestellen.</p>
                <p>Beachten Sie bitte folgende Besonderheiten:</p>
                <ol>
                  <li>Beim <strong>Abmessen</strong> des Rollladenpanzers muss der <strong>Platzbedarf</strong> im Rollladenkasten beachtet werden. Die genauen <strong>Ballendurchmesser</strong> der einzelnen Profile finden Sie in der jeweiligen Produktbeschreibung.</li>
                  <li>Alle Ma√üangaben erfolgen in <strong>Millimetern</strong>.
                    <br>1 Zentimeter = 10 Millimeter.
                    <br>10 Zentimeter = 100 Millimeter.
                    <br>100 Zentimeter = 1 Meter bzw. 1.000 Millimeter.
                  </li>
                  <li>Hinweise zur <strong>Behangbreite</strong> finden Sie weiter unten.</li>
                  <li>Folgendes <strong>Zubeh√∂r</strong> wird bei unseren Rollladenpanzern standardgem√§√ü mitgeliefert:
                    <ul>
                      <li><strong>Sicherungsfedern</strong> in ausreichender Menge</li>
                      <li><strong>Endleiste</strong> aus Aluminium (Optional w√§hlbar)</li>
                      <li><strong>Anschlagstopper</strong> 30 mm, 40 mm, 60 mm (Optional w√§hlbar)</li>
                    </ul>
                  </li>
                  <li>Sollten Sie zus√§tzlich noch <strong>F√ºhrungsschienen</strong> ben√∂tigen, finden Sie entsprechende F√ºhrungsschienen im Katalog (Meterware).</li>
                </ol>

                <h4>Ma√üermittlung bei PVC-Panzern</h4>
                <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 2rem;">
                  <div style="flex: 1; min-width: 300px;">
                    <p>Zur Ermittlung der <strong>Bestellbreite (B)</strong> messen Sie bitte von <strong>Innenkante F√ºhrungsschiene</strong> links bis <strong>Innenkante F√ºhrungsschiene</strong> rechts an mindestens drei Punkten - Oben, Mitte und Unten (Innenlichte der F√ºhrungsschienen muss unbedingt mitgemessen werden) und ziehen Sie von dem ermittelten Ma√ü insgesamt <strong>10 mm</strong> (5 mm je Seite) ab.</p>
                    <p style="background: #f9f9f9; padding: 10px; border-left: 3px solid #333;"><strong>Beispiel:</strong> Haben Sie die kleinste Breite von <strong>1320 mm</strong> (von Innenkante F√ºhrungsschiene links bis Innenkante F√ºhrungsschiene rechts) ermittelt, so rechnen Sie die Fertigbreite wie folgt:<br><strong>1320 mm - 10 mm = 1310 mm</strong></p>
                  </div>
                  <div style="flex: 0 0 300px; max-width: 100%;">
                     <img src="{{ 'messanleitung-breite.png' | asset_url }}" alt="Draufsicht F√ºhrungsschienen zur Breitenmessung" style="width: 100%; height: auto; border: 1px solid #eee; border-radius: 4px;">
                     <small style="display: block; text-align: center; color: #666; margin-top: 5px; font-style: italic;">Abb.1 Draufsicht F√ºhrungsschienen zur Breitenmessung</small>
                   </div>
                 </div>
 
                 <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 2rem;">
                   <div style="flex: 1; min-width: 300px;">
                     <p>Zur Ermittlung der <strong>Bestellh√∂he (H)</strong> messen Sie von der <strong>Fensterbank</strong> bzw. dem <strong>Auflaufpunkt</strong> bis zur <strong>Mitte der Rollladenwelle</strong> im Rollladenkasten. Sollte die H√∂he des Rollladenkastens bequem ersichtlich sein (<strong>z.B. 300 mm</strong>) , k√∂nnen Sie auch von dem Auflaufpunkt bis zur Unterkante des Rollladenkastens messen und die halbe H√∂he des Rollladenkastens (in diesem  Beispiel <strong>150 mm</strong>) hinzuf√ºgen. <strong></strong>.</p>
                     <p style="background: #f9f9f9; padding: 10px; border-left: 3px solid #333;"><strong>Beispiel:</strong> Haben Sie eine H√∂he von <strong>1000 mm</strong> von der Fensterbank bzw. dem Auflaufpunkt bis zur Unterkante des Rollladenkastens <strong>PLUS</strong> der errechneten halben H√∂he des Rollladenkastens <strong>150 mm</strong>, so ergibt sich eine Fertigh√∂he von <strong> 1150 mm.</strong></p>
                   </div>
                   <div style="flex: 0 0 300px; max-width: 100%;">
                     <img src="{{ 'messanleitung-hoehe.png' | asset_url }}" alt="Frontansicht zur H√∂henmessung" style="width: 100%; height: auto; border: 1px solid #eee; border-radius: 4px;">
                     <small style="display: block; text-align: center; color: #666; margin-top: 5px; font-style: italic;">Abb.2 Frontansicht zur H√∂henmessung</small>
                   </div>
                 </div>
 
                 <h4 style="color: #d00;">Achtung !!</h4>
                 <h4>Hinweise zur Messung von Aluminiumpanzern:</h4>
                 <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
                   <div style="flex: 1; min-width: 300px;">
                     <p>Bitte beachten Sie, dass bei Rollladenpanzern aus <strong>Aluminium</strong> die <strong>Profilbreite</strong> nicht der <strong>Bestellbreite</strong> entspricht. Aus diesem Grund sollten die Ma√üe in der weitesten <strong>Breite samt den Arretierungen</strong> genommen werden. Die <strong>Arretierung</strong> tr√§gt auf beiden Seiten jeweils <strong>5 mm</strong> auf.</p>
                   </div>
                   <div style="flex: 0 0 300px; max-width: 100%;">
                     <img src="{{ 'messanleitung-alu.png' | asset_url }}" alt="Bestellbreite und Profilbreite" style="width: 100%; height: auto; border: 1px solid #eee; border-radius: 4px;">
                     <small style="display: block; text-align: center; color: #666; margin-top: 5px; font-style: italic;">Abb.3 Bestellbreite 1 und Profilbreite 2</small>
                   </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Color Selection -->
    <div class="form-group">
      <label>
        Farbe
        <div class="tooltip-wrapper">
          <div class="tooltip-trigger">?</div>
          <div class="tooltip-content">
            <h4>Farbauswahl</h4>
            <p>Unsere Farben sind hochwertig pulverbeschichtet und UV-best√§ndig, um ein Ausbleichen zu verhindern.</p>
            <p>Bitte beachten Sie, dass die Bildschirmdarstellung leicht vom Original abweichen kann. Sonderfarben sind mit (S) gekennzeichnet und sind mit einem kleinen Aufpreis versehen. Sonderfarben sind nicht immer in gro√üen Mengen vorr√§tig. Sollte Ihre Bestellung gro√üe Mengen beinhalten, kann es zu Verz√∂gerungen bei der Lieferung kommen.</p>
            <!-- Placeholder for image -->
            <div style="margin-top:10px; height: 100px; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.8rem;">
              Bild: Farbpalette
            </div>
          </div>
        </div>
      </label>
      <div id="color-options" class="color-preview">
        <!-- Dynamically populated by JS -->
      </div>
    </div>

    <!-- Endleiste (Finishing Bar) Section - Always Enabled -->
    <div class="endleiste-section">
      <h3>
        Endleiste (Aluminium)
        <div class="tooltip-wrapper">
          <div class="tooltip-trigger">?</div>
          <div class="tooltip-content">
            <h4>Endleisten-Optionen</h4>
            <p>Die Endleiste bildet den unteren Abschluss des Rollladenpanzers.</p>
            <p><strong>Mit Stopper-L√∂chern:</strong> F√ºr die Montage von Anschlagstoppern (Standard).</p>
            <p><strong>Ohne L√∂cher:</strong> Falls Sie verdeckte Anschl√§ge oder eine Winkelendschiene verwenden.</p>
            <!-- Placeholder for image -->
            <div style="margin-top:10px; height: 100px; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.8rem;">
              Bild: Endleiste mit/ohne Stopper
            </div>
          </div>
        </div>
      </h3>

      <div id="endleiste-options" class="endleiste-options active">
        <!-- Color Selection -->
        <div class="form-group">
          <label>Endleisten-Farbe</label>
          <div id="endleiste-color-options" class="color-preview">
            <!-- Dynamically populated by JS -->
          </div>
        </div>

        <!-- Holes for Stoppers -->
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="endleiste-holes" name="endleiste-holes" checked>
            <label for="endleiste-holes" style="margin-bottom: 0;">L√∂cher f√ºr Stopper (Standard)</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Price Display -->
    <div class="price-display">
      <div class="label">Gesamtpreis</div>
      <div class="amount">
        <span class="currency">‚Ç¨</span><span id="total-price">0.00</span>
      </div>
      <div id="price-details" style="display:none; text-align: left; margin-top: 1rem; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 0.5rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
          <span>Grundpreis:</span>
          <span id="base-price-display">0.00 ‚Ç¨</span>
        </div>
        <div id="surcharge-row" style="display: flex; justify-content: space-between; margin-bottom: 0.25rem; color: #666;">
          <span>Aufpreise:</span>
          <span id="surcharge-display">0.00 ‚Ç¨</span>
        </div>
      </div>
      <div id="chargeable-area-wrapper" style="display:none; font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
        (Berechnet: <span id="chargeable-area-display">1.000</span> m¬≤)
      </div>
      <div class="minimum-warning" id="minimum-warning">
        Mindestbestellung: 1,0 m¬≤ - Gesamtfl√§che wird mit Mindestpreis berechnet
      </div>
    </div>

    <!-- Quantity Selector -->
    <div class="quantity-section">
      <label for="quantity">Menge</label>
      <div class="quantity-input-group">
        <button type="button" id="quantity-decrease" class="quantity-btn" aria-label="Decrease quantity">‚àí</button>
        <input type="number" id="quantity" name="quantity" value="1" min="1" max="999">
        <button type="button" id="quantity-increase" class="quantity-btn" aria-label="Increase quantity">+</button>
      </div>
    </div>

    <!-- Add to Cart Button -->
    <button type="button" id="add-to-cart-btn" class="add-to-cart-btn">
      In den Warenkorb
    </button>
  </form>
</div>

<script src="{{ 'roller-config.js' | asset_url }}?v={{ 'now' | date: '%s' }}" defer></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const guard = document.getElementById('auth-guard');
  const content = document.getElementById('customizer-content');
  
  // if (!window.AuthManager.isAuthenticated()) {
  //   guard.innerHTML = `
  //     <div style="text-align: center; padding: 2rem;">
  //       <p style="font-size: 1.1rem; color: #666; margin-bottom: 2rem;">
  //         Bitte melden Sie sich an, um den Konfigurator zu nutzen.
  //       </p>
  //       <a href="/pages/auth" style="display: inline-block; padding: 0.75rem 1.5rem; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; font-weight: 600;">
  //         Zur Anmeldung
  //       </a>
  //     </div>
  //   `;
  // } else {
    guard.style.display = 'none';
    content.style.display = 'block';
    console.log('[Auth] Customizer visible (Auth bypassed for testing)');
  // }
});
</script>

{% schema %}
{
  "name": "Roller Customizer",
  "tag": "section",
  "class": "section",
  "settings": []
}
{% endschema %}
